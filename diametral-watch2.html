<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Diametral Trio - Precisão de Engenharia</title>
    <style>
        :root {
            --panel-bg: rgba(255, 255, 255, 0.12);
            --accent: #ff9900;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
            background-color: #e5e5e7;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
            transition: background-color 0.8s ease;
        }

        /* Área do Relógio com Zoom dinâmico */
        #zoomWrapper {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.15s ease-out;
            will-change: transform;
            z-index: 1;
        }

        #canvasContainer {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas {
            display: block;
            border-radius: 50%;
            filter: drop-shadow(0 40px 80px rgba(0,0,0,0.15));
        }

        /* --- UI FIXA --- */
        .fixed-ui {
            position: fixed;
            z-index: 1000;
            pointer-events: auto;
        }

        #settingsBtn {
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(15px);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.4);
            transition: transform 0.3s ease;
        }

        #settingsBtn:hover { transform: rotate(45deg); background: rgba(255, 255, 255, 0.5); }
        #settingsBtn svg { width: 22px; height: 22px; fill: #111; }

        #configPanel {
            top: 75px;
            right: 20px;
            width: 250px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(35px) saturate(160%);
            border-radius: 24px;
            padding: 22px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translateX(350px);
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            color: #111;
        }

        #configPanel.open { transform: translateX(0); }

        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
        }

        .control-row label { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .control-row input[type="color"] { border: none; width: 30px; height: 30px; cursor: pointer; background: none; border-radius: 50%; padding: 0; }

        .btn-group { display: flex; gap: 8px; margin-top: 18px; }
        .action-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-size: 9px; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: 0.2s; }

        #randomBtn { background: rgba(255,255,255,0.4); color: #000; }
        #saveBtn { background: #111; color: #fff; }

        #timeUi {
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px);
            padding: 14px 32px;
            border-radius: 60px;
            display: flex;
            gap: 24px;
            align-items: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.06);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .mode-btn { background: #111; color: white; border: none; padding: 10px 18px; border-radius: 30px; cursor: pointer; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .mode-btn.active { background: var(--accent); color: #000; }

        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #111;
            color: #fff;
            padding: 10px 24px;
            border-radius: 30px;
            font-size: 11px;
            opacity: 0;
            transition: opacity 0.4s;
            pointer-events: none;
            z-index: 2000;
        }

        input[type="range"] { appearance: none; width: 110px; height: 3px; background: rgba(0,0,0,0.1); border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; background: var(--accent); border-radius: 50%; cursor: pointer; border: 3px solid #fff; }
    </style>
</head>
<body>

    <div id="toast">Estado Guardado</div>

    <!-- UI FIXA -->
    <div id="settingsBtn" class="fixed-ui" title="Configurações">
        <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.81,11.69,4.81,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.5c-1.93,0-3.5-1.57-3.5-3.5 s1.57-3.5,3.5-3.5s3.5,1.57,3.5,3.5S13.93,15.5,12,15.5z"/></svg>
    </div>

    <div id="configPanel" class="fixed-ui">
        <h3>Design Trio</h3>
        <div class="control-row">
            <label>Mostrador</label>
            <input type="color" id="faceCol" value="#ffffff">
        </div>
        <div class="control-row">
            <label>Marcador</label>
            <input type="color" id="handCol" value="#ff9900">
        </div>
        <div class="control-row">
            <label>Tipografia</label>
            <input type="color" id="textCol" value="#111111">
        </div>
        <div class="control-row">
            <label>Caixa</label>
            <input type="color" id="caseCol" value="#d8d8d8">
        </div>
        
        <div class="btn-group">
            <button id="randomBtn" class="action-btn">Aleatório</button>
            <button id="saveBtn" class="action-btn">Guardar</button>
        </div>
    </div>

    <div id="timeUi" class="fixed-ui">
        <button id="modeBtn" class="mode-btn active">Tempo Real</button>
        <div style="display: flex; flex-direction: column; gap: 4px;">
            <label style="font-size: 8px; font-weight: 900; color: #777; text-transform: uppercase;">Simulação</label>
            <input type="range" id="speedRange" min="0" max="100" value="0">
        </div>
    </div>

    <div id="zoomWrapper">
        <div id="canvasContainer">
            <canvas id="watchCanvas"></canvas>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('watchCanvas');
        const ctx = canvas.getContext('2d');
        const zoomWrapper = document.getElementById('zoomWrapper');
        const toastEl = document.getElementById('toast');
        const STORAGE_KEY = 'diametral_trio_v_pro_precise';

        // --- ESTADO ---
        let colors = { face: "#ffffff", hand: "#ff9900", text: "#111111", watch: "#d8d8d8", bezel: "#0a0a0a" };
        let zoomScale = 1.0;
        let isRealTime = true;
        let speedMult = 0;
        let virtualOffset = 0;
        let lastTime = 0;

        const inputs = {
            face: document.getElementById('faceCol'),
            hand: document.getElementById('handCol'),
            text: document.getElementById('textCol'),
            watch: document.getElementById('caseCol')
        };

        // --- CORES ---
        function hexToHsl(hex) {
            let r = parseInt(hex.slice(1, 3), 16) / 255;
            let g = parseInt(hex.slice(3, 5), 16) / 255;
            let b = parseInt(hex.slice(5, 7), 16) / 255;
            let max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max === min) h = s = 0;
            else {
                let d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return { h: h * 360, s: s * 100, l: l * 100 };
        }

        function hslToHex(h, s, l) {
            l /= 100;
            const a = s * Math.min(l, 1 - l) / 100;
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`;
        }

        function deriveFromFace(faceHex) {
            const hsl = hexToHsl(faceHex);
            const textL = hsl.l > 60 ? 12 : 92;
            const text = hslToHex(hsl.h, hsl.l > 60 ? 15 : 5, textL);
            const handH = (hsl.h + 180) % 360;
            const hand = hslToHex(handH, 95, 55);
            const watchL = hsl.l > 50 ? Math.max(10, hsl.l - 25) : Math.min(90, hsl.l + 25);
            const watch = hslToHex(hsl.h, Math.max(0, hsl.s - 25), watchL);
            const bezel = hslToHex(hsl.h, Math.max(0, hsl.s - 20), 8);
            colors = { face: faceHex, hand, text, watch, bezel };
            updateUI();
        }

        function updateUI() {
            Object.keys(colors).forEach(k => { if(inputs[k]) inputs[k].value = colors[k]; });
            document.documentElement.style.setProperty('--accent', colors.hand);
            const bodyHsl = hexToHsl(colors.face);
            document.body.style.backgroundColor = hslToHex(bodyHsl.h, 10, 92);
            zoomWrapper.style.transform = `scale(${zoomScale})`;
        }

        function showToast(msg) {
            toastEl.innerText = msg; toastEl.style.opacity = 1;
            setTimeout(() => toastEl.style.opacity = 0, 2500);
        }

        // --- INTERAÇÕES ---
        window.addEventListener('wheel', (e) => {
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            zoomScale = Math.max(0.5, Math.min(3.0, zoomScale + delta));
            updateUI();
        }, { passive: false });

        let touchDist = 0;
        window.addEventListener('touchstart', (e) => { if(e.touches.length === 2) touchDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); });
        window.addEventListener('touchmove', (e) => {
            if(e.touches.length === 2 && touchDist > 0) {
                const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                zoomScale = Math.max(0.5, Math.min(3.0, zoomScale + (dist - touchDist) / 180));
                touchDist = dist; updateUI();
            }
        }, { passive: false });

        document.getElementById('saveBtn').onclick = () => {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ colors, zoomScale }));
            showToast("Design e Zoom Guardados");
        };
        document.getElementById('randomBtn').onclick = () => deriveFromFace('#'+Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'));
        document.getElementById('settingsBtn').onclick = () => document.getElementById('configPanel').classList.toggle('open');
        inputs.face.oninput = (e) => deriveFromFace(e.target.value);
        Object.keys(inputs).forEach(k => { if(k !== 'face' && inputs[k]) inputs[k].oninput = (e) => colors[k] = e.target.value; });

        // --- RENDERIZAÇÃO ---
        function resize() {
            const width = window.innerWidth, height = window.innerHeight;
            const baseSize = Math.min(width * 0.8, height * 0.6, 500);
            const dpr = window.devicePixelRatio || 1;
            canvas.width = baseSize * dpr; canvas.height = baseSize * dpr;
            canvas.style.width = baseSize + 'px'; canvas.style.height = baseSize + 'px';
            ctx.scale(dpr, dpr);
        }
        window.addEventListener('resize', resize);
        resize();

        document.getElementById('modeBtn').onclick = (e) => { isRealTime = !isRealTime; e.target.classList.toggle('active', isRealTime); e.target.innerText = isRealTime ? "Tempo Real" : "Modo Demo"; };
        document.getElementById('speedRange').oninput = (e) => { speedMult = parseFloat(e.target.value); if(speedMult > 0 && isRealTime) { isRealTime = false; document.getElementById('modeBtn').classList.remove('active'); document.getElementById('modeBtn').innerText = "Modo Demo"; } };

        function draw(timestamp) {
            if(!lastTime) lastTime = timestamp;
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;
            const size = parseFloat(canvas.style.width);
            const cx = size / 2, cy = size / 2, r = size * 0.44;
            ctx.clearRect(0, 0, size, size);

            // 1. Hardware
            ctx.fillStyle = colors.watch;
            ctx.beginPath(); ctx.roundRect(cx - r*1.1, cy - r*1.35, r*2.2, r*2.7, 25); ctx.fill();
            ctx.fillStyle = "#181818"; ctx.fillRect(cx - r*0.75, 0, r*1.5, size);
            ctx.beginPath(); ctx.arc(cx, cy, r + 18, 0, Math.PI * 2); ctx.fillStyle = colors.bezel; ctx.fill();

            // 2. Bezel Lines
            ctx.save();
            ctx.translate(cx, cy); ctx.strokeStyle = "rgba(255,255,255,0.3)";
            for(let i=0; i<60; i++) {
                const angle = (i / 60) * Math.PI * 2 - Math.PI / 2;
                const isMajor = i % 5 === 0;
                ctx.beginPath(); ctx.lineWidth = isMajor ? 1.5 : 0.8;
                ctx.moveTo(Math.cos(angle) * (r + 2), Math.sin(angle) * (r + 2));
                ctx.lineTo(Math.cos(angle) * (r + (isMajor ? 11 : 6)), Math.sin(angle) * (r + (isMajor ? 11 : 6)));
                ctx.stroke();
            }
            ctx.restore();

            // 3. Mostrador (Clip)
            ctx.save();
            ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.clip();
            ctx.fillStyle = colors.face; ctx.fill();

            const now = new Date();
            let t = isRealTime ? 
                (now.getHours() % 12) * 3600 + now.getMinutes() * 60 + now.getSeconds() + now.getMilliseconds() / 1000 :
                (now.getHours() % 12) * 3600 + now.getMinutes() * 60 + now.getSeconds() + (virtualOffset += dt * speedMult * 50);

            const minAngle = ((t % 3600) / 3600) * Math.PI * 2 - Math.PI / 2;
            const pivotAngle = minAngle + Math.PI;
            const pivotX = cx + Math.cos(pivotAngle) * r;
            const pivotY = cy + Math.sin(pivotAngle) * r;
            const hourDecimal = (t % 43200) / 3600;
            const numR = r * 1.60, markR = numR - 48;
            const phi = minAngle - ((hourDecimal / 12) * Math.PI * 2 - Math.PI / 2);

            // Disco Excêntrico
            ctx.save();
            ctx.translate(pivotX, pivotY); ctx.rotate(phi);
            ctx.fillStyle = colors.text;
            for (let i = 1; i <= 12; i++) {
                const angle = (i / 12) * Math.PI * 2 - Math.PI / 2;
                ctx.save();
                ctx.translate(Math.cos(angle) * numR, Math.sin(angle) * numR); ctx.rotate(angle + Math.PI / 2);
                ctx.font = `300 ${r * 0.22}px Arial`; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.fillText(i.toString(), 0, 0); ctx.restore();
                ctx.beginPath(); ctx.arc(Math.cos(angle) * markR, Math.sin(angle) * markR, 3.5, 0, Math.PI * 2); ctx.fill();
                for (let j = 1; j < 12; j++) {
                    const sa = angle + (j / 144) * Math.PI * 2;
                    ctx.beginPath(); ctx.arc(Math.cos(sa) * markR, Math.sin(sa) * markR, j % 2 === 0 ? 1.2 : 0.7, 0, Math.PI * 2); ctx.fill();
                }
            }
            ctx.restore();

            // 4. MARCADOR DIAMETRAL & MEIA-LUA DE ALTA PRECISÃO
            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(minAngle + Math.PI / 2);
            ctx.fillStyle = colors.hand;
            
            // Geometria da Meia-lua
            const crescentOuterRadius = 7.5;
            const crescentStroke = 1.4;
            
            // CORREÇÃO CRÍTICA DA HASTE: 
            // A haste deve parar antes de entrar no "corpo" da meia-lua invertida.
            // Quando a lua está invertida (180 graus no ponto -r), a sua borda inferior está em -r + 3px aprox.
            const shaftSafetyStop = 4.5; 

            // Haste Principal: Agora termina antes do início da meia-lua
            ctx.fillRect(-1.1, -r + shaftSafetyStop, 2.2, (r * 2) - shaftSafetyStop); 

            // Desenho da Meia-Lua (Invertida)
            ctx.save();
            ctx.translate(0, -r);
            ctx.rotate(Math.PI);
            ctx.beginPath();
            // Arco exterior
            ctx.arc(0, 0, crescentOuterRadius, Math.PI * 0.15, Math.PI * 0.85, true);
            // Arco interior (muito próximo para manter a finura e precisão)
            ctx.arc(0, 2.5, crescentOuterRadius - crescentStroke, Math.PI * 0.8, Math.PI * 0.2, false);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
            
            ctx.restore();
            ctx.restore(); // Fim clip mostrador

            // 5. Overlay Lente (Vidro Convexo)
            const g1 = ctx.createRadialGradient(cx, cy, r * 0.85, cx, cy, r);
            g1.addColorStop(0, "transparent"); g1.addColorStop(1, "rgba(0,0,0,0.25)");
            ctx.fillStyle = g1; ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.fill();
            const g2 = ctx.createRadialGradient(cx - r*0.3, cy - r*0.3, 0, cx, cy, r * 1.5);
            g2.addColorStop(0, "rgba(255,255,255,0.15)"); g2.addColorStop(1, "rgba(0,0,0,0.08)");
            ctx.fillStyle = g2; ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI * 2); ctx.fill();
            const shine = ctx.createRadialGradient(cx - r*0.4, cy - r*0.4, r*0.05, cx - r*0.4, cy - r*0.4, r*0.5);
            shine.addColorStop(0, "rgba(255,255,255,0.3)"); shine.addColorStop(1, "rgba(255,255,255,0)");
            ctx.fillStyle = shine; ctx.save(); ctx.beginPath(); ctx.ellipse(cx - r*0.35, cy - r*0.35, r*0.4, r*0.2, Math.PI * 0.75, 0, Math.PI * 2); ctx.fill(); ctx.restore();

            requestAnimationFrame(draw);
        }

        const saved = localStorage.getItem(STORAGE_KEY);
        if(saved) {
            try {
                const data = JSON.parse(saved);
                colors = data.colors || colors;
                zoomScale = data.zoomScale || 1.0;
            } catch(e) {}
        }
        updateUI();
        requestAnimationFrame(draw);
    </script>
</body>
</html>